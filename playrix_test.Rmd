---
title: "Тестовое задание на вакансию Data Scientist"
author: "Григорий Михолап"
date: "18 мая 2016 г."
output: html_document
---

```{r echo=F, results='hide', warning=F, message=F, error=F}
library(boot)
library(mytools)
library(car)
library("ggplot2")
library(xtable)
# library(devtools)
# install_github('mytools', 'Grag2015')
```

```{r echo=F}
# пользовательская ф-я для вывода параметров регрессионной модели
printlm <- function(model){
  tempsum <- summary(model)
  cat("Residual standard error:", format(signif(tempsum$sigma, 
                                                4)), "on", tempsum$df[2L], "degrees of freedom")
  cat("\n")
  cat("Multiple R-squared:  ", round(tempsum$r.squared, digits=4),  "Adjusted R-squared:  ",
      round(tempsum$adj.r.squared, digits=4))
  cat("\n")
  cat("F-statistic: ", round(tempsum$fstatistic[1],2), "on", round(tempsum$fstatistic[2],0), 
      "and", round(tempsum$fstatistic[3],0), "DF,  p-value:",
      format.pval(pf(tempsum$fstatistic[1L],tempsum$fstatistic[2L], 
                     tempsum$fstatistic[3L], lower.tail = FALSE)))
}
```


### Постановка задачи

--------------------

**Задача**: изучить нашу игру Township и ответить на вопросы ниже, связанные с поведением игроков. 

**Об игре**: Township - успешная free-to-play игра для мобильных платформ с уникальным сочетанием жанров city-builder и farming. Ежедневная аудитория игры более миллиона человек. 

Продукты производятся на фабриках и выращиваются на полях. Все они хранятся в амбаре и участвуют в заказах от жителей города. Заказы делаются в интерфейсе карты города (можно попасть по иконке с вертолётом в интерфейсе или по тапу на вертолётной площадке). Если заказ игроку не хочется выполнять, то он может удалить его (кнопка с урной), после этого потребуется время на генерацию нового заказа.
Для ответов на этот вопрос вам понадобится статистика игроков. Вот [таблица](https://www.dropbox.com/s/v3doceefutm15r5/refused_order_products.csv?dl=0) где указано, сколько заказов, содержащих данный продукт, удалили пользователи, на различных уровнях игры  
Таблица с характеристиками продукта [здесь](https://www.dropbox.com/s/99vlm2ytd1der25/product_info.csv?dl=0).

**Вопрос**: заказы с какими продуктами игроки чаще удаляют на карте заказов и почему?

---------------------

### Изучение механики игры
После изучения механики игры (прошел 15 уровней) возникло несколько замечаний и предположений, касающихся поставленного вопроса:

1. **Стратегия производства товаров**  
Количество отклоненных продуктов зависит от выбранной стратегии игры (какие товары и в каком количестве производить). Например, если мы производим только пшеницу, корм для коров и молоко, то все заказы с кукурузой мы будем отклонять. Ниже я описал нюансы 2-х крайних стратегий - продажи под заказ и продажи со склада. 

2. **Продажи под заказ**   
Продажа товаров по заказам жителей выгодней, т.к. они стоят как правило дороже и дополнительно к выручке мы получаем опыт. Однако эти заказы приходят пакетами из нескольких товаров и пакеты формируются случайным образом, что усложняет планирование загрузки. Тем более мы имеем ограниченную вместимость склада и не можем хранить все произведенные товары, ожидая пока на них поступит заказ. 

3. **Продажи из амбара**  
Это наверное самая простая стратегия, которая приходит на ум - производить максимально много и продавать сразу из амбара. В таком случае мы избегаем проблем с загрузкой склада и не подстраиваемся под случайные запросы от жителей. (в смешанном варианте мы можем исполнять их от случая к случаю при наличии товаров на складе)

4. **Смешанная стратегия**  
В реальности конечно игроки пользуются комбинациями 2-х описанных выше стратегий - что-то продается со склада, что-то продается под заказ. Кроме того, также дополнительный фактор случайности добавляет загрузка поезда. В отличие от заказов жителей, которые мы можем игнорировать или отклонять, заказы по загрузке поезда нужно выполнять, т.к. поезд доставляет нам строительные материалы, которые необходимы для развития города. Стройматериалы мы сами не можем произвести и стоят они достаточно дорого.

5. **Схема формирования заказов**  
Также возник вопрос, а есть ли какая-нибудь закономерность при формировании пакета заказов?
Ведь очевидно, что если какой-нибудь продукт возникает в заказах чаще других, то вероятно что и количество отклонений такого заказа будет выше. Также опыт игры показал, что в среднем в заказе количество каждого товара не превосходит 1-2 единицы, но иногда в заказе есть товары в количестве 9-12 единиц, такие заказы также сложней выполнять и они должны чаще отклоняться. 

------------------------------------

**Загрузка данных**.  
Программный код, который используется в отчете, в т.ч. и некоторые операции (такие как загрузка и подготовка данных для анализа) не были включены в отчет, при необходимости все эти данные вы можете найти [по ссылке](https://github.com/Grag2015/testWG/blob/master/Task%204%20Fruit.Rmd) 

```{r echo=F, results='hide'}
# загрузка данных об отказах в более удобном виде (предварительно подготовил в excel)
refused_order_products2=read.csv("refused_order_products_prepared.csv",sep = ";",header = T, dec = ',')

```


```{r echo=F, results='hide'}
# найдем для товаров сумму отказов по всем уровням и среднее значение

refused_order_products2$sum <- refused_order_products2$X10.12
refused_order_products2$mean <- refused_order_products2$X10.12

for (i in 1:nrow(refused_order_products2)){
    refused_order_products2$sum[i] <- sum(refused_order_products2[i,2:7],na.rm = T)
    # т.к. при расчете среднего необходимо удалять этапы с небольшим числом отклонений
    # то организуем расчет среднего самостоятельно
    n <- 0
    s <- 0
    for (j in 2:7) {
        if (refused_order_products2[i,j]!=0 & !is.na(refused_order_products2[i,j]) & rowMeans(refused_order_products2[i,2:7], na.rm = T, dims = 1)[1]/refused_order_products2[i,j]<10)
        {
            n <- n+1
            s <- s+refused_order_products2[i,j]
        }   
    }
    if (n==0) {
        n <- n+1
    }
    refused_order_products2$mean[i] <- s/n
}
```

```{r echo=F, results='hide'}
# загрузим все товары и добавим к ним матрицу с отказами
tovary_all=read.csv("tovary_all.csv",sep = ";",header = T, dec = ',')
tovary=read.csv("tovary.csv",sep = ";",header = T, dec = ',')

tt <- merge(tovary_all, refused_order_products2, by.x="id_product", by.y="tovary", all.x=FALSE)

# добавим фактор разбивающи показатель "уровень" на 5 частей (для визуализации)
tt$uroven_cat <- cut(tt$uroven,breaks = c(0,20,40,60,80))

```

----------------------------------

### Анализ данных

**ТОП-10 самых удаляемых заказов**
по общей сумме отказов 
```{r}
head(tt[order(tt$sum,decreasing = T),c('title','sum')], n=10)
```

по среднему (среднее расчитано среди групп уровней  10-12, 13-15 и т.д.)
```{r}
head(tt[order(tt$mean,decreasing = T),c('title','mean')], n=10)
```


**Анализ схемы формирования заказа**

Ручная проверка 20 различных заказов (на 15-м уровне) показала, что продукты появляются примерно с одинаковой частотой (на этой выборке не удалось отклонить нулевую гипотезу о равенстве распределений). Появление продукта в заказе подчиняется распределению Бернулли с вероятностью успеха 0.15. Это грубая оценка, доверительный интервал для нее 0.032-0.379
и вероятно она может изменяться для различных уровней. Главное предположение для нас состоит в том, что все продукты появляются в заказе по одному и тому же закону. **И в таком случае частота появления продукта не влияет на количество отказов.**

Также было замечено, что продукты появляются с разным количеством, и вероятней всего, чем больше количество, тем выше вероятность, что такой пакет продуктов будет отклонен (т.к. его сложней собрать). Данное предположение требует большего количества проверок различных запросов, т.к. количество товаров моделируется распределением Пуассона и если исследовать для каждого продукта хотя бы 20 заказов с ним, с учетом частоты появления каждого продукта нужно вручную проанализировать 133 заказа. Поэтому этот пункт не был исследован.

**Исследуем характеристики продуктов**

Посмотрим на визуализацию характеристик наших продуктов

```{r echo=F, results='hide'}
ggplot(data = tt, aes(x=mean, y=vremya_rosta, col=uroven_cat, size=stoim_cash))+
    geom_point()+
    xlab("Среднее количество отказов за период")+
    ylab("Время роста")+
    labs(title="Визуализация основных показателей (цвет - уровень)")+
    scale_size_continuous(name="Стоимость кэш")+
    scale_color_discrete(name="Уровень")
```


На основании этой визуализации можно выделить 2 кластера, которые стоит анализировать по отдельности. Итак, 1-й кластер - группа в виде столбика в нижней левой части диаграммы. Это товары с невысоким средним значеним уровня отказов (меньше 3000), судя по размеру точки они достаточно дорогие и появляются они на уровне от 20 до 40. Также в этой группе находятся товары, которые не заказывают обычно, такие, например, как корма для животных.
И 2-й кластер - облако из красных и зеленых точек внизу диаграмы, это ядро наших товаров. 

```{r echo=F, results='hide'}
ggplot(data = tt, aes(x=mean, y=vremya_rosta, col=razdel, size=stoim_cash))+
    geom_point()+
    xlab("Среднее количество отказов за период")+
    ylab("Время роста")+
    labs(title="Визуализация основных показателей (цвет - сырье/товары)")+
    scale_size_continuous(name="Стоимость кэш")+
    scale_color_discrete(name="Уровень")
```

На графике выше отдельным цветом обозначены товары (которые производятся на фабрике/ферме) и сырье (то, что выращивается на полях). Глядя на диаграмму разобъем 2-й кластер еще на 2 кластера - на товары и сырье.

### Анализ кластера 2

Отметим, что между соседними уровнями (точнее группами уровней 10-12, 13-15 и т.д.) существует достаточно сильная корреляция и наоборот чем дальше анализируемые уровни друг от друга, тем меньше они коррелируют.

```{r echo=F, warning=F, message=F, error=F}
pairs2(tt[,8:13])
```

В связи с этим наблюдением и для упрощения анализа я не анализировал каждый уровень по отдельности, а взял сумму отказов по всем группам уровней и проанализировал от каких параметров она зависит.


### Линейная модель для связи показателей товаров и количества отказов

Для анализа влияния показателей продуктов построим 2 линейные модели по отдельности для "товаров" и для "сырья"

```{r}
model_full <- lm(sum ~ uroven+stoim_ambar, data = tt[tt$mean>3000 & tt$razdel=="Товары",]) # 
```
```{r echo=F}
printlm(model_full)
```
```{r results='asis', echo=F}
xt <- xtable(summary(model_full))
print(xt, type="html")
```

т.о. мы получили достаточно точную модель - уточненный коэффициент детерминации равен 0.85 и все коэффициенты статистически значимы. Данная модель дает нам аналитическую запись зависимости количества отказов для товара (напомню, что это сумма отказов по всем уровням 10-33) от Времени роста, Уровня появления товара и Стоимости покупки за кеш.

`sum = 289551 - 6266*uroven - 386*stoim_ambar`

Т.о. общее количество отказов сильно зависит от уровня ввода товара в игру - это логично, т.к. сумма показатель накопительный. Более интересно, то что сумма достаточно сильно зависит от стоимости продажи из амбара - прирост стоимости на 1 у.е. ведет к снижение количества отказов на 386 единиц. По моим наблюдениям стоимость заявок прямо-пропорциональна стоимости продуктов входящих в заказ и поэтому увеличение стоимости продажи из амбара влечет увеличение стоимости заказов, которые содержат данный продукт. И тогда согласно нашей модели получается, что чем дороже заказ, тем реже от него отказываются.

**Линейная модель для сырья**
```{r}
model_full2 <- lm(sum ~ uroven+stoim_ambar+vremya_rosta, data = tt[tt$mean>3000 & tt$razdel=="Сырье",]) # 
```
```{r echo=F}
printlm(model_full2)
```
```{r results='asis', echo=F}
xt <- xtable(summary(model_full2))
print(xt, type="html")
```

Т.о. для сырья зависимость Суммы от показателей выглядит так:

`sum = 229941 - 225*vremya_rosta - 8655*uroven + 7911*stoim_ambar`

Если сравнить 2 модели можно увидеть интересные различия:

1. Интересно, что показатель Время роста, который не попал в модель для товаров (как статистически незначимый), попал в модель для сырья. Низкая информативность Времени роста для товаров связана видимо с тем, что для товаров показатель время роста показывает только время производства товара на фабрике/ферме, но не учитывает время на производство сырья для данного товара.

2. Стоимость из амбара в модели для Сырья изменила знак, т.е. имеет теперь положительное и судя по величине коэффициента очень сильное влияние. 

**Диагностика моделей**
```{r echo=F, results='hide'}
test1 <- shapiro.test(model_full$residuals)
cat(ifelse(test1$p.value < 0.05, "Остатки не распределены нормально", "Остатки распределены нормально"), ", p-значение: ", test1$p.value)


test2 <- durbinWatsonTest(model_full)
cat(ifelse(test2$p < 0.05, "Есть зависимость", "Нет зависимости"), ", p-значение: ", test2$p)

test3 <- ncvTest(model_full)
cat(ifelse(test3$p < 0.05, "Гомоскедастичность НЕ выполняется", "Гомоскедастичность выполняется"), ", p-значение: ", test3$p)
```
Диагностика моделей показала, что остатки в моделях распределены нормально и они независимы. Не выполняется только гомоскедастичность дисперсии, но для целей данного отчета мы не будем заниматься подгонкой модели.

### Ответ на вопрос:
Т.о. выше мы рассчитали ТОП-10 самых частотных по отказам товаров.
С помощью линейной модели отдельно для случая товаров и сырья рассчитали значимость факторов, которые влияют на уровень отказов.

### Дополнительно:
Построение линейной модели сбалансированности игры для случая продажи из амбара 

Ниже для списка товаров доступного на 12 уровне построена линейная модель, которая учитывает взаимосвязь продукт-сырье, время роста, стоимость семян, а также ограничения на количество полей, количество мест на фермах. Ниже без детального описания приведен код для решения этой задачи. Все необходимые матрицы были подготовлены заранее и доступны по ссылкам выше.
```{r}
#setwd("d:/YandexDisk/Data analysis/Разное/Playrix_test/")

X=read.csv("matrix_X.csv",sep = ";",header = F) # матрица продукт-сырье
v=as.matrix(read.csv("vector_v.csv",sep = ";")) # вектор стоимости товаров при продаже из амбара
v_sem=as.matrix(read.csv("vector_vsem.csv",sep = ";")) # вектор стоимости семян
df_A1 <- read.csv("matrix_A1.csv",sep = ";",dec = ',') # матрица с ограничениями на количество полей и мест на фермах

a <- t(v) %*% as.matrix(X) - t(v_sem) # Целевая функция (также учтена стоимость семян)

A2 <- as.matrix(X) # количество произведенных товаров должно быть не меньше количества товаров, использованных в качестве сырья
b2 <- as.matrix(rep(0.0, times = 21))
# ограничения на количество полей и мест на фермах
# также здесь учтено ограничение, что на фабрике товары производятся последовательно
A1 <- as.matrix(df_A1[,1:21])
b1 <- as.matrix(df_A1[,22])

# данная задача решается симплекс методом.
sol <- simplex(a, A1, b1, A2, b2, maxi=T)
```

Рассчитаем какие продукты нужно производить для двух случаев
1. без ограничений на количество каких-либо продуктов
2. по-максимуму производить самый дорогой товар на 12 уровне - бублик

```{r echo=F, results='hide'}
# первый случай без требований к списку нужных товаров уже решен выше
solution <- data.frame(row.names = tovary$title)
solution$var1 <- sol$soln
print(sol$value)
# будем по-максимуму производить самый дорогой товар на 12 уровне - бублик
b2 <- as.matrix(rep(0.0, times = 21))
b2[14] <- 0.22
sol <- simplex(a, A1, b1, A2, b2, maxi=T)
solution$var2 <- sol$soln
print(sol$value)
```

для случая 1. имеем максимальную выручку за 20 мин. игры равную 163 монеты, количество товаров, которое нужно произвести см. в таблице ниже в столбце var1

для случая 2. имеем максимальную выручку за 20 мин. игры равную 154 монеты, количество товаров, которое нужно произвести см. в таблице ниже в столбце var2

Как мы видим, не всегда ставка на самый дорогой товар, как в случае var2, дает максимальный выигрыш в игре. Наша модель для самого оптимального варианта var1 предлагает производить небольшую группу товаров - Пшеницу, Морковь, Корм для кур, Яйца и Печенье. При этом ставка делается на Пшеницу, а Печенье оптимальная модель добавила как самую выгодную производную продукцию.
```{r echo=F}
solution
```


